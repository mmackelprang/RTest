@page "/spotify"
@rendermode InteractiveServer
@inject SpotifyApiService SpotifyApi
@inject QueueApiService QueueApi
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>Spotify - Radio Console</PageTitle>

<div class="spotify-page" style="padding: 24px; height: 100%; display: flex; flex-direction: column;">
  
  @if (!_isAuthenticated)
  {
    <!-- Authentication Prompt -->
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
      <MudIcon Icon="@Icons.Material.Filled.LibraryMusic" Style="font-size: 120px; margin-bottom: 24px; color: #1DB954;" />
      <MudText Typo="Typo.h4" Style="margin-bottom: 16px;">Connect to Spotify</MudText>
      <MudText Typo="Typo.body1" Style="margin-bottom: 32px; color: var(--text-secondary);">
        Sign in to your Spotify account to search and play music
      </MudText>
      <MudButton Variant="Variant.Filled" 
                 Color="Color.Success" 
                 Size="Size.Large" 
                 OnClick="HandleLoginAsync"
                 StartIcon="@Icons.Material.Filled.Login"
                 Style="min-width: 200px; min-height: 60px;">
        Login to Spotify
      </MudButton>
    </div>
  }
  else
  {
    <!-- Authenticated View -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <MudText Typo="Typo.h4">Spotify</MudText>
      <div style="display: flex; gap: 16px; align-items: center;">
        <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">Logged in as: @_userName</MudText>
        <MudButton Variant="Variant.Outlined" 
                   Color="Color.Default" 
                   Size="Size.Small" 
                   OnClick="HandleLogoutAsync"
                   StartIcon="@Icons.Material.Filled.Logout">
          Logout
        </MudButton>
      </div>
    </div>
    
    <!-- Search Bar -->
    <div style="margin-bottom: 16px;">
      <MudTextField @bind-Value="_searchQuery" 
                    Label="Search Spotify" 
                    Variant="Variant.Outlined" 
                    Adornment="Adornment.End" 
                    AdornmentIcon="@Icons.Material.Filled.Search"
                    OnAdornmentClick="HandleSearchAsync"
                    OnKeyUp="@(async (e) => { if (e.Key == "Enter") await HandleSearchAsync(); })"
                    Style="width: 100%;" />
    </div>
    
    <!-- Filter Pills -->
    <div style="margin-bottom: 24px; display: flex; gap: 8px; flex-wrap: wrap;">
      <MudChip T="string" Text="All" Variant="@(_selectedFilters.Contains("all") ? Variant.Filled : Variant.Outlined)" 
               Color="@(_selectedFilters.Contains("all") ? Color.Primary : Color.Default)"
               OnClick="@(() => ToggleFilter("all"))">All</MudChip>
      <MudChip T="string" Text="Tracks" Variant="@(_selectedFilters.Contains("track") ? Variant.Filled : Variant.Outlined)" 
               Color="@(_selectedFilters.Contains("track") ? Color.Primary : Color.Default)"
               OnClick="@(() => ToggleFilter("track"))">Music</MudChip>
      <MudChip T="string" Text="Albums" Variant="@(_selectedFilters.Contains("album") ? Variant.Filled : Variant.Outlined)" 
               Color="@(_selectedFilters.Contains("album") ? Color.Primary : Color.Default)"
               OnClick="@(() => ToggleFilter("album"))">Albums</MudChip>
      <MudChip T="string" Text="Artists" Variant="@(_selectedFilters.Contains("artist") ? Variant.Filled : Variant.Outlined)" 
               Color="@(_selectedFilters.Contains("artist") ? Color.Primary : Color.Default)"
               OnClick="@(() => ToggleFilter("artist"))">Artists</MudChip>
      <MudChip T="string" Text="Playlists" Variant="@(_selectedFilters.Contains("playlist") ? Variant.Filled : Variant.Outlined)" 
               Color="@(_selectedFilters.Contains("playlist") ? Color.Primary : Color.Default)"
               OnClick="@(() => ToggleFilter("playlist"))">Playlists</MudChip>
      <MudButton Variant="Variant.Outlined" 
                 Color="Color.Default" 
                 Size="Size.Small" 
                 OnClick="HandleBrowseAsync"
                 StartIcon="@Icons.Material.Filled.Explore">
        Browse
      </MudButton>
    </div>
    
    <!-- Browse View -->
    @if (_isBrowsing)
    {
      <div style="flex: 1; overflow-y: auto;">
        @if (_isLoadingBrowse)
        {
          <div style="display: flex; justify-content: center; padding: 64px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
          </div>
        }
        else if (_selectedCategory == null && _browseCategories != null)
        {
          <MudText Typo="Typo.h6" Style="margin-bottom: 16px;">Categories</MudText>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;">
            @foreach (var category in _browseCategories)
            {
              <MudCard Outlined="true" Style="cursor: pointer;" @onclick="@(() => LoadCategoryPlaylistsAsync(category))">
                <MudCardContent Style="text-align: center; padding: 16px;">
                  @if (!string.IsNullOrEmpty(category.IconUrl))
                  {
                    <img src="@category.IconUrl" alt="@category.Name" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" />
                  }
                  else
                  {
                    <MudIcon Icon="@Icons.Material.Filled.Category" Style="font-size: 80px; margin-bottom: 8px; color: var(--text-secondary);" />
                  }
                  <MudText Typo="Typo.body2">@category.Name</MudText>
                </MudCardContent>
              </MudCard>
            }
          </div>
        }
        else if (_selectedCategory != null && _categoryPlaylists != null)
        {
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="BackToCategoriesAsync" title="Back to Categories" />
            <MudText Typo="Typo.h6">@_selectedCategory.Name</MudText>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;">
            @foreach (var playlist in _categoryPlaylists)
            {
              <MudCard Outlined="true" Style="cursor: pointer;">
                <MudCardContent Style="text-align: center; padding: 16px;">
                  @if (!string.IsNullOrEmpty(playlist.ImageUrl))
                  {
                    <img src="@playlist.ImageUrl" alt="@playlist.Name" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" />
                  }
                  else
                  {
                    <MudIcon Icon="@Icons.Material.Filled.PlaylistPlay" Style="font-size: 100px; margin-bottom: 8px; color: var(--text-secondary);" />
                  }
                  <MudText Typo="Typo.body2" Style="font-weight: 600;">@playlist.Name</MudText>
                  <MudText Typo="Typo.caption" Style="color: var(--text-secondary);">@playlist.TotalTracks tracks</MudText>
                </MudCardContent>
                <MudCardActions Style="justify-content: center;">
                  <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" 
                                 Color="Color.Primary" 
                                 OnClick="@(() => HandlePlayPlaylistAsync(playlist.Id))" 
                                 title="Play Playlist" />
                  <MudIconButton Icon="@Icons.Material.Filled.AddToQueue" 
                                 Color="Color.Default" 
                                 OnClick="@(() => HandleAddPlaylistToQueueAsync(playlist.Id))" 
                                 title="Add to Queue" />
                </MudCardActions>
              </MudCard>
            }
          </div>
        }
      </div>
    }
    <!-- Search Results -->
    else if (_isSearching)
    {
      <div style="display: flex; justify-content: center; padding: 64px;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
      </div>
    }
    else if (_searchResults != null)
    {
      <div style="flex: 1; overflow-y: auto;">
        <!-- Tracks -->
        @if (_searchResults.Tracks?.Any() == true)
        {
          <MudText Typo="Typo.h6" Style="margin-bottom: 16px;">Tracks</MudText>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
            @foreach (var track in _searchResults.Tracks.Take(10))
            {
              <MudCard Style="cursor: pointer;" @onclick="@(() => HandlePlayTrackAsync(track.Uri))">
                <MudCardMedia Image="@(track.AlbumArtUrl ?? "/icons/music-note.svg")" Height="200" />
                <MudCardContent Style="padding: 12px;">
                  <MudText Typo="Typo.body2" Style="font-weight: 600; margin-bottom: 4px;">@track.Name</MudText>
                  <MudText Typo="Typo.caption" Style="color: var(--text-secondary);">@track.Artist</MudText>
                </MudCardContent>
                <MudCardActions Style="padding: 8px;">
                  <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Size="Size.Small" OnClick="@(() => HandlePlayTrackAsync(track.Uri))" title="Play" />
                  <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="@(() => HandleAddToQueueAsync(track.Uri))" title="Add to Queue" />
                </MudCardActions>
              </MudCard>
            }
          </div>
        }
        
        <!-- Albums -->
        @if (_searchResults.Albums?.Any() == true)
        {
          <MudText Typo="Typo.h6" Style="margin-bottom: 16px;">Albums</MudText>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
            @foreach (var album in _searchResults.Albums.Take(6))
            {
              <MudCard Style="cursor: pointer;">
                <MudCardMedia Image="@(album.ImageUrl ?? "/icons/album.svg")" Height="200" />
                <MudCardContent Style="padding: 12px;">
                  <MudText Typo="Typo.body2" Style="font-weight: 600; margin-bottom: 4px;">@album.Name</MudText>
                  <MudText Typo="Typo.caption" Style="color: var(--text-secondary);">@album.Artist</MudText>
                </MudCardContent>
              </MudCard>
            }
          </div>
        }
        
        <!-- Playlists -->
        @if (_searchResults.Playlists?.Any() == true)
        {
          <MudText Typo="Typo.h6" Style="margin-bottom: 16px;">Playlists</MudText>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
            @foreach (var playlist in _searchResults.Playlists.Take(6))
            {
              <MudCard Style="cursor: pointer;">
                <MudCardMedia Image="@(playlist.ImageUrl ?? "/icons/playlist.svg")" Height="200" />
                <MudCardContent Style="padding: 12px;">
                  <MudText Typo="Typo.body2" Style="font-weight: 600;">@playlist.Name</MudText>
                </MudCardContent>
              </MudCard>
            }
          </div>
        }
      </div>
    }
    else if (!string.IsNullOrEmpty(_searchQuery))
    {
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
        <MudIcon Icon="@Icons.Material.Filled.SearchOff" Style="font-size: 120px; margin-bottom: 16px; opacity: 0.5;" />
        <MudText Typo="Typo.h5">No results found</MudText>
        <MudText Typo="Typo.body2" Style="margin-top: 8px;">Try a different search term</MudText>
      </div>
    }
    else
    {
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
        <MudIcon Icon="@Icons.Material.Filled.Search" Style="font-size: 120px; margin-bottom: 16px; opacity: 0.5;" />
        <MudText Typo="Typo.h5">Search for music</MudText>
        <MudText Typo="Typo.body2" Style="margin-top: 8px;">Enter a song, artist, album, or playlist name</MudText>
      </div>
    }
  }
</div>

@code {
  private bool _isAuthenticated = false;
  private string? _userName = null;
  private string _searchQuery = "";
  private List<string> _selectedFilters = new() { "all" };
  private SpotifySearchResultsDto? _searchResults = null;
  private bool _isSearching = false;
  
  // Browse state
  private bool _isBrowsing = false;
  private bool _isLoadingBrowse = false;
  private List<SpotifyCategoryDto>? _browseCategories = null;
  private SpotifyCategoryDto? _selectedCategory = null;
  private List<SpotifyPlaylistDto>? _categoryPlaylists = null;

  protected override async Task OnInitializedAsync()
  {
    await CheckAuthStatusAsync();
  }

  private async Task CheckAuthStatusAsync()
  {
    try
    {
      var status = await SpotifyApi.GetAuthStatusAsync();
      if (status != null)
      {
        _isAuthenticated = status.IsAuthenticated;
        _userName = status.UserName;
      }
    }
    catch (Exception)
    {
      _isAuthenticated = false;
    }
  }

  private async Task HandleLoginAsync()
  {
    try
    {
      var authUrl = await SpotifyApi.GetAuthUrlAsync($"{NavigationManager.BaseUri}spotify/callback");
      if (authUrl != null && !string.IsNullOrEmpty(authUrl.Url))
      {
        // Store state and code verifier in session storage
        // For now, just navigate to the OAuth URL
        NavigationManager.NavigateTo(authUrl.Url, forceLoad: true);
      }
    }
    catch (Exception)
    {
      // Silently fail
    }
  }

  private async Task HandleLogoutAsync()
  {
    try
    {
      await SpotifyApi.LogoutAsync();
      _isAuthenticated = false;
      _userName = null;
      _searchResults = null;
      _searchQuery = "";
    }
    catch (Exception)
    {
      // Silently fail
    }
  }

  private void ToggleFilter(string filter)
  {
    if (filter == "all")
    {
      _selectedFilters.Clear();
      _selectedFilters.Add("all");
    }
    else
    {
      _selectedFilters.Remove("all");
      if (_selectedFilters.Contains(filter))
      {
        _selectedFilters.Remove(filter);
      }
      else
      {
        _selectedFilters.Add(filter);
      }
      
      if (!_selectedFilters.Any())
      {
        _selectedFilters.Add("all");
      }
    }
  }

  private async Task HandleSearchAsync()
  {
    if (string.IsNullOrWhiteSpace(_searchQuery)) return;
    
    _isBrowsing = false;
    _isSearching = true;
    try
    {
      var types = _selectedFilters.Contains("all") 
        ? new List<string> { "track", "album", "artist", "playlist" }
        : _selectedFilters;
      
      _searchResults = await SpotifyApi.SearchAsync(_searchQuery, types);
    }
    catch (Exception)
    {
      // Silently fail
    }
    finally
    {
      _isSearching = false;
    }
  }

  private async Task HandlePlayTrackAsync(string uri)
  {
    try
    {
      await SpotifyApi.PlayUriAsync(uri, null);
    }
    catch (Exception)
    {
      // Silently fail
    }
  }

  private async Task HandleAddToQueueAsync(string uri)
  {
    try
    {
      await QueueApi.AddToQueueAsync(uri);
    }
    catch (Exception)
    {
      // Silently fail
    }
  }

  private async Task HandleBrowseAsync()
  {
    _isBrowsing = true;
    _searchResults = null;
    _searchQuery = "";
    _isLoadingBrowse = true;
    _selectedCategory = null;
    _categoryPlaylists = null;
    
    try
    {
      _browseCategories = await SpotifyApi.GetCategoriesAsync();
    }
    catch (Exception)
    {
      // Silently fail
    }
    finally
    {
      _isLoadingBrowse = false;
    }
  }

  private async Task LoadCategoryPlaylistsAsync(SpotifyCategoryDto category)
  {
    _selectedCategory = category;
    _isLoadingBrowse = true;
    
    try
    {
      _categoryPlaylists = await SpotifyApi.GetCategoryPlaylistsAsync(category.Id);
    }
    catch (Exception)
    {
      // Silently fail
    }
    finally
    {
      _isLoadingBrowse = false;
    }
  }

  private async Task HandlePlayPlaylistAsync(string playlistId)
  {
    try
    {
      await SpotifyApi.PlayPlaylistAsync(playlistId);
    }
    catch (Exception)
    {
      // Silently fail
    }
  }

  private async Task HandleAddPlaylistToQueueAsync(string playlistId)
  {
    try
    {
      // Note: Spotify API doesn't provide individual track URIs in playlist response
      // As a workaround, we play the playlist which loads all tracks
      // A full implementation would require fetching playlist tracks and adding each to queue
      await SpotifyApi.PlayPlaylistAsync(playlistId);
    }
    catch (Exception)
    {
      // Silently fail
    }
  }

  private void BackToCategoriesAsync()
  {
    _selectedCategory = null;
    _categoryPlaylists = null;
  }

  public void Dispose()
  {
    // Cleanup if needed
  }
}
