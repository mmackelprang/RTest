@page "/visualizer"
@using Radio.Web.Services.Hub
@using Radio.Web.Models
@using Microsoft.JSInterop
@inject AudioVisualizationHubService VisualizationHub
@inject IJSRuntime JS
@inject ILogger<VisualizerPage> Logger
@implements IAsyncDisposable

<PageTitle>Audio Visualizer - Radio Console</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4" Style="height: 100%;">
  <MudStack Spacing="2" Style="height: 100%;">
    
    @* Header with mode selector *@
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
      <MudText Typo="Typo.h4">Audio Visualizer</MudText>
      
      <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        @if (!VisualizationHub.IsConnected)
        {
          <MudChip T="string" Color="Color.Warning" Size="Size.Small">Disconnected</MudChip>
        }
        else
        {
          <MudChip T="string" Color="Color.Success" Size="Size.Small">Connected</MudChip>
        }
        
        <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Medium">
          <MudButton OnClick="@(() => SelectMode(VisualizationMode.VUMeter))" 
                     Variant="@(currentMode == VisualizationMode.VUMeter ? Variant.Filled : Variant.Outlined)">
            VU Meter
          </MudButton>
          <MudButton OnClick="@(() => SelectMode(VisualizationMode.Waveform))" 
                     Variant="@(currentMode == VisualizationMode.Waveform ? Variant.Filled : Variant.Outlined)">
            Waveform
          </MudButton>
          <MudButton OnClick="@(() => SelectMode(VisualizationMode.Spectrum))" 
                     Variant="@(currentMode == VisualizationMode.Spectrum ? Variant.Filled : Variant.Outlined)">
            Spectrum
          </MudButton>
        </MudButtonGroup>
      </MudStack>
    </MudStack>

    @* Canvas container *@
    <MudPaper Elevation="2" Class="pa-4 flex-grow-1" Style="background-color: #1a1a1a; min-height: 400px;">
      <canvas id="visualizer-canvas" style="width: 100%; height: 100%; display: block;"></canvas>
    </MudPaper>

    @* Status and stats *@
    @if (lastUpdateTime.HasValue)
    {
      <MudText Typo="Typo.caption" Color="Color.Secondary">
        Last update: @lastUpdateTime.Value.ToString("HH:mm:ss.fff")
        @if (updateCount > 0)
        {
          <text> | Updates: @updateCount</text>
        }
      </MudText>
    }

  </MudStack>
</MudContainer>

@code {
  private enum VisualizationMode
  {
    VUMeter,
    Waveform,
    Spectrum
  }

  private VisualizationMode currentMode = VisualizationMode.VUMeter;
  private bool isInitialized = false;
  private DateTime? lastUpdateTime;
  private int updateCount = 0;
  private IJSObjectReference? jsModule;

  protected override async Task OnInitializedAsync()
  {
    try
    {
      // Start SignalR connection if not already connected
      if (!VisualizationHub.IsConnected)
      {
        await VisualizationHub.StartAsync();
      }

      // Subscribe to events based on current mode
      await SubscribeToCurrentMode();

      // Register event handlers
      VisualizationHub.OnLevelData += HandleLevelData;
      VisualizationHub.OnWaveformData += HandleWaveformData;
      VisualizationHub.OnSpectrumData += HandleSpectrumData;

      Logger.LogInformation("VisualizerPage initialized");
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error initializing VisualizerPage");
    }
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender)
    {
      try
      {
        // Load JavaScript module
        jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/visualizer.js");

        // Initialize canvas
        var canvasWidth = 1800; // Fit within 1920px with padding
        var canvasHeight = 400;
        
        var success = await jsModule.InvokeAsync<bool>("visualizer.init", "visualizer-canvas", canvasWidth, canvasHeight);
        
        if (success)
        {
          isInitialized = true;
          Logger.LogInformation("Canvas initialized successfully");
          
          // Request initial data
          await RequestInitialData();
        }
        else
        {
          Logger.LogError("Failed to initialize canvas");
        }
      }
      catch (Exception ex)
      {
        Logger.LogError(ex, "Error in OnAfterRenderAsync");
      }
    }
  }

  private async Task SelectMode(VisualizationMode mode)
  {
    if (currentMode == mode) return;

    // Unsubscribe from current mode
    await UnsubscribeFromCurrentMode();

    currentMode = mode;

    // Subscribe to new mode
    await SubscribeToCurrentMode();

    // Clear canvas
    if (isInitialized && jsModule != null)
    {
      try
      {
        await jsModule.InvokeVoidAsync("visualizer.clear", "visualizer-canvas");
      }
      catch (Exception ex)
      {
        Logger.LogError(ex, "Error clearing canvas");
      }
    }

    // Request initial data for new mode
    await RequestInitialData();

    StateHasChanged();
  }

  private async Task SubscribeToCurrentMode()
  {
    try
    {
      switch (currentMode)
      {
        case VisualizationMode.VUMeter:
          await VisualizationHub.SubscribeToLevelsAsync();
          break;
        case VisualizationMode.Waveform:
          await VisualizationHub.SubscribeToWaveformAsync();
          break;
        case VisualizationMode.Spectrum:
          await VisualizationHub.SubscribeToSpectrumAsync();
          break;
      }
      Logger.LogDebug("Subscribed to {Mode}", currentMode);
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error subscribing to {Mode}", currentMode);
    }
  }

  private async Task UnsubscribeFromCurrentMode()
  {
    try
    {
      switch (currentMode)
      {
        case VisualizationMode.VUMeter:
          await VisualizationHub.UnsubscribeFromLevelsAsync();
          break;
        case VisualizationMode.Waveform:
          await VisualizationHub.UnsubscribeFromWaveformAsync();
          break;
        case VisualizationMode.Spectrum:
          await VisualizationHub.UnsubscribeFromSpectrumAsync();
          break;
      }
      Logger.LogDebug("Unsubscribed from {Mode}", currentMode);
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error unsubscribing from {Mode}", currentMode);
    }
  }

  private async Task RequestInitialData()
  {
    try
    {
      switch (currentMode)
      {
        case VisualizationMode.VUMeter:
          var levels = await VisualizationHub.GetLevelsAsync();
          if (levels != null)
          {
            await HandleLevelData(levels);
          }
          break;
        case VisualizationMode.Waveform:
          var waveform = await VisualizationHub.GetWaveformAsync();
          if (waveform != null)
          {
            await HandleWaveformData(waveform);
          }
          break;
        case VisualizationMode.Spectrum:
          var spectrum = await VisualizationHub.GetSpectrumAsync();
          if (spectrum != null)
          {
            await HandleSpectrumData(spectrum);
          }
          break;
      }
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error requesting initial data");
    }
  }

  private async Task HandleLevelData(LevelDataDto data)
  {
    if (!isInitialized || jsModule == null || currentMode != VisualizationMode.VUMeter)
      return;

    try
    {
      await jsModule.InvokeVoidAsync("visualizer.drawVUMeter", 
        "visualizer-canvas",
        data.LeftPeak,
        data.RightPeak,
        data.LeftRms,
        data.RightRms,
        data.IsClipping);

      lastUpdateTime = DateTime.Now;
      updateCount++;

      await InvokeAsync(StateHasChanged);
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error drawing VU meter");
    }
  }

  private async Task HandleWaveformData(WaveformDataDto data)
  {
    if (!isInitialized || jsModule == null || currentMode != VisualizationMode.Waveform)
      return;

    try
    {
      await jsModule.InvokeVoidAsync("visualizer.drawWaveform",
        "visualizer-canvas",
        data.LeftSamples,
        data.RightSamples);

      lastUpdateTime = DateTime.Now;
      updateCount++;

      await InvokeAsync(StateHasChanged);
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error drawing waveform");
    }
  }

  private async Task HandleSpectrumData(SpectrumDataDto data)
  {
    if (!isInitialized || jsModule == null || currentMode != VisualizationMode.Spectrum)
      return;

    try
    {
      await jsModule.InvokeVoidAsync("visualizer.drawSpectrum",
        "visualizer-canvas",
        data.Magnitudes,
        data.Frequencies);

      lastUpdateTime = DateTime.Now;
      updateCount++;

      await InvokeAsync(StateHasChanged);
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error drawing spectrum");
    }
  }

  public async ValueTask DisposeAsync()
  {
    try
    {
      // Unsubscribe from events
      VisualizationHub.OnLevelData -= HandleLevelData;
      VisualizationHub.OnWaveformData -= HandleWaveformData;
      VisualizationHub.OnSpectrumData -= HandleSpectrumData;

      // Unsubscribe from current mode
      await UnsubscribeFromCurrentMode();

      // Dispose canvas
      if (jsModule != null)
      {
        await jsModule.InvokeVoidAsync("visualizer.dispose", "visualizer-canvas");
        await jsModule.DisposeAsync();
      }

      Logger.LogInformation("VisualizerPage disposed");
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error disposing VisualizerPage");
    }
  }
}
